<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>TheGrandChess9 ‚Ä¢ Secure Portal</title>

<style>
:root {
  --bg-dark: #0f172a;
  --bg-panel: #1e293b;
  --primary: #22c55e;
  --primary-hover: #16a34a;
  --danger: #ef4444;
  --text-main: #f8fafc;
  --text-muted: #94a3b8;
  --border: rgba(255,255,255, 0.1);
  --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
}

* { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }

body {
  margin: 0;
  font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
  background-color: var(--bg-dark);
  color: var(--text-main);
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  overflow-x: hidden;
}

header {
    height: 60px;
    background: #1e293b; /* Yeh Light Dark Blue hai (Black nahi) */
    border-bottom: 1px solid rgba(255,255,255, 0.1);
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 20px;
    position: sticky;
    top: 0;
    z-index: 50;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); /* Thoda shadow add kiya */
  }


/* Logo Link Styling */
.brand-link {
  text-decoration: none;
  display: flex;
  align-items: center;
  gap: 10px;
  cursor: pointer;
  transition: opacity 0.2s;
}

.brand-link:hover {
  opacity: 0.8;
}

.brand {
  font-size: 18px;
  font-weight: 700;
  color: white;
}

.brand-logo {
  width: 36px;
  height: 36px;
  background: white;
  border-radius: 6px;
  padding: 2px;
  display: grid;
  place-items: center;
  color: var(--bg-dark);
  font-weight: 900;
  font-size: 20px;
}

.app-container {
  display: grid;
  grid-template-columns: 320px 1fr;
  min-height: calc(100vh - 60px);
}

.sidebar {
  background: var(--bg-panel);
  border-right: 1px solid var(--border);
  padding: 20px;
  display: flex;
  flex-direction: column;
  gap: 24px;
}

.main-content {
  padding: 20px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  background: radial-gradient(circle at center, #1e293b 0%, #0f172a 100%);
}

.card {
  background: rgba(30, 41, 59, 0.7);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 20px;
  box-shadow: var(--shadow);
}

.card-title {
  font-size: 12px;
  text-transform: uppercase;
  letter-spacing: 1px;
  color: var(--text-muted);
  margin-bottom: 12px;
  font-weight: 700;
  padding-bottom: 8px;
  border-bottom: 1px solid rgba(255,255,255,0.05);
}

.input-group {
  position: relative;
  margin-bottom: 16px;
}

.input-group input {
  width: 100%;
  background: #0f172a;
  border: 1px solid var(--border);
  color: white;
  padding: 12px 16px;
  border-radius: 8px;
  font-size: 14px;
  transition: all 0.2s;
}

.input-group input:focus {
  border-color: var(--primary);
  box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.2);
}

.toggle-password {
  position: absolute;
  right: 12px;
  top: 50%;
  transform: translateY(-50%);
  cursor: pointer;
  color: var(--text-muted);
  font-size: 18px;
  user-select: none;
}

.btn {
  width: 100%;
  padding: 12px;
  border-radius: 8px;
  border: none;
  font-weight: 600;
  font-size: 14px;
  cursor: pointer;
  transition: all 0.2s;
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 8px;
  margin-bottom: 10px;
}

.btn-primary { background: var(--primary); color: #052e16; }
.btn-primary:hover { background: var(--primary-hover); }

.btn-secondary {
  background: transparent;
  border: 1px solid var(--border);
  color: var(--text-main);
}
.btn-secondary:hover { background: rgba(255,255,255,0.05); border-color: var(--text-muted); }

.btn-danger {
  background: rgba(239, 68, 68, 0.15);
  color: #fca5a5;
  border: 1px solid rgba(239, 68, 68, 0.3);
}
.btn-danger:hover { background: rgba(239, 68, 68, 0.25); }

.btn:disabled { opacity: 0.6; cursor: not-allowed; filter: grayscale(1); }

.spinner {
  width: 16px;
  height: 16px;
  border: 2px solid currentColor;
  border-bottom-color: transparent;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin { to { transform: rotate(360deg); } }

.status-box {
  padding: 12px;
  border-radius: 8px;
  font-size: 13px;
  line-height: 1.4;
  margin-bottom: 16px;
  display: none;
}
.status-warning {
  background: rgba(234, 179, 8, 0.1);
  border: 1px solid rgba(234, 179, 8, 0.3);
  color: #fde047;
  display: block;
}
.status-success {
  background: rgba(34, 197, 94, 0.1);
  border: 1px solid rgba(34, 197, 94, 0.3);
  color: #86efac;
  display: block;
}

/* Game Grid Styling */
.game-section {
  margin-bottom: 20px;
}

.game-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
}

.game-btn {
  background: rgba(255,255,255,0.03);
  border: 1px solid var(--border);
  color: var(--text-muted);
  padding: 15px 10px;
  border-radius: 8px;
  text-align: center;
  cursor: pointer;
  transition: all 0.2s;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 4px;
}

.game-btn small {
  font-size: 11px;
  opacity: 0.7;
}

.game-btn:hover {
  background: rgba(255,255,255,0.08);
  color: white;
  border-color: var(--primary);
  transform: translateY(-2px);
}

.hero-placeholder {
  text-align: center;
  max-width: 500px;
}
.hero-icon {
  font-size: 48px;
  margin-bottom: 16px;
  opacity: 0.5;
}

.game-frame-wrapper {
  width: 100%;
  height: 100%;
  position: relative;
  display: none;
  flex-direction: column;
}

iframe {
  width: 100%;
  height: 120vh; /* 80vh ko 160vh kar diya (Double) */
  border: none;
  border-radius: 12px;
  background: #000;
  box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
}

.loading-overlay {
  position: absolute;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(15, 23, 42, 0.8);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 10;
  border-radius: 12px;
  backdrop-filter: blur(4px);
}

#toast {
  position: fixed;
  top: 20px;
  left: 50%;
  transform: translateX(-50%) translateY(-20px);
  background: #1e293b;
  border: 1px solid var(--border);
  color: white;
  padding: 10px 20px;
  border-radius: 50px;
  font-size: 14px;
  box-shadow: 0 10px 15px rgba(0,0,0,0.3);
  z-index: 100;
  opacity: 0;
  pointer-events: none;
  transition: all 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55);
  display: flex;
  align-items: center;
  gap: 8px;
}

#toast.show {
  opacity: 1;
  transform: translateX(-50%) translateY(0);
}
#toast.success { border-color: var(--primary); color: var(--primary); }
#toast.error { border-color: var(--danger); color: var(--danger); }

@media (max-width: 768px) {
  .app-container { grid-template-columns: 1fr; }
  .sidebar { border-right: none; border-bottom: 1px solid var(--border); order: 2; }
  .main-content { order: 1; min-height: 50vh; }
  iframe { height: 60vh; }
}
</style>
</head>
<body>

<div id="toast">
  <span id="toast-icon"></span>
  <span id="toast-msg">Notification</span>
</div>

<header>
    <div style="display: flex; align-items: center; gap: 12px; height: 60px;">
    
    <!-- LOGO WITH LINK (White Border added for visibility) -->
    <a href="index.html" style="text-decoration: none; display: flex; align-items: center;">
      <img src="img/Logo.png" alt="TheGrandChess9 Logo" 
           style="height: 40px; width: auto; 
                  padding: 4px; background: white; 
                  border-radius: 6px; object-fit: contain;">
    </a>

    <!-- BRAND NAME -->
    <div class="brand">TheGrandChess9</div>
    
  </div>
  
  <div style="font-size:12px; color:var(--text-muted);" id="connectionStatus">‚óè System Ready</div>
</header>

<div class="app-container">
  
  <aside class="sidebar">
    
    <!-- 1. AUTH FORM -->
    <div id="authSection" class="card">
      <div class="card-title">üîê Account Access</div>
      
      <form id="authForm" onsubmit="return false;">
        <div class="input-group">
          <input type="email" id="email" placeholder="Email Address" required autocomplete="email">
        </div>
        
        <div class="input-group">
          <input type="password" id="password" placeholder="Password" required autocomplete="current-password">
          <span class="toggle-password" onclick="window.togglePasswordVisibility()">üëÅÔ∏è</span>
        </div>

        <button type="submit" id="loginBtn" class="btn btn-primary">
          <span class="btn-text">Login</span>
        </button>
        
        <button type="button" id="signupBtn" class="btn btn-secondary">
          Create Account
        </button>

        <button type="button" id="forgotBtn" class="btn" style="color:var(--text-muted); font-size:12px; margin-top:5px;">
          Forgot Password?
        </button>
      </form>
    </div>

    <!-- 2. PROFILE: UNVERIFIED -->
    <div id="unverifiedSection" class="card" style="display: none;">
      <div class="card-title">‚ö†Ô∏è Action Required</div>
      
      <div class="status-box status-warning">
        <strong>Email not verified.</strong><br>
        We sent a link to your inbox. Click it to auto-login.
      </div>
      
      <div style="font-size:13px; color:var(--text-muted); margin-bottom:15px; text-align:center; word-break:break-all;" id="pendingEmailDisplay">
        user@example.com
      </div>

      <button id="resendBtn" class="btn btn-primary">
        üì© Resend Email
      </button>
      <button id="logoutUnverifiedBtn" class="btn btn-secondary">
        Sign Out
      </button>
    </div>

    <!-- 3. PROFILE: VERIFIED -->
    <div id="profileSection" class="card" style="display: none;">
      <div class="card-title">‚úÖ Player Profile</div>
      
      <div style="text-align:center; margin-bottom:15px;">
        <div style="font-size:24px; font-weight:bold; color:var(--primary); margin-bottom:4px;">Grandmaster</div>
        <div style="font-size:13px; color:var(--text-muted); word-break:break-all;" id="userEmailDisplay"></div>
      </div>

      <div class="status-box status-success">
        Access Granted. You can play.
      </div>

      <button id="logoutBtn" class="btn btn-danger">
        Log Out
      </button>
    </div>

    <!-- GAME MENU (Separated Sections) -->
    <div id="gameMenu" style="display:none; margin-top: auto;">
      
      <!-- Section 1: Play Online With Friend -->
      <div class="game-section">
        <div class="card-title">üë• Play Online (With Friend)</div>
        <div class="game-grid">
          <div class="game-btn" onclick="window.loadGame('chess8x8.html')">
            <strong>Chess 8x8</strong>
            <small>Classic Rules</small>
          </div>
          <div class="game-btn" onclick="window.loadGame('chess9x9.html')">
            <strong>Chess 9x9</strong>
            <small>Expanded Board</small>
          </div>
        </div>
      </div>

      <!-- Section 2: vs Computer AI -->
      <div class="game-section">
        <div class="card-title">ü§ñ vs Computer AI</div>
        <div class="game-grid">
          <div class="game-btn" onclick="window.loadGame('SuperChess8x8.html')">
            <strong>SuperChess 8x8</strong>
            <small>AI Opponent</small>
          </div>
          <div class="game-btn" onclick="window.loadGame('SuperChess9x9.html')">
            <strong>SuperChess 9x9</strong>
            <small>AI Opponent</small>
          </div>
        </div>
      </div>

    </div>

  </aside>

  <main class="main-content">
    
    <div id="heroSection" class="hero-placeholder">
      <div class="hero-icon">‚ôüÔ∏è</div>
      <h1 style="font-size: 24px; margin-bottom: 10px; color:white;">Welcome to TheGrandChess9</h1>
      <p style="color: var(--text-muted); line-height: 1.6;">
        Secure login required. Create an account, verify email, and play.
      </p>
    </div>

    <div id="gameContainer" class="game-frame-wrapper">
      <div class="loading-overlay" id="gameLoader" style="display:none;">
        <div class="spinner" style="width:30px; height:30px; border-color:white; border-bottom-color:transparent;"></div>
      </div>
      <iframe id="gameFrame" allowfullscreen></iframe>
    </div>

  </main>
</div>

<!-- Firebase SDKs -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { 
    getAuth, 
    signInWithEmailAndPassword, 
    createUserWithEmailAndPassword,
    signOut, 
    sendPasswordResetEmail, 
    onAuthStateChanged, 
    sendEmailVerification, 
    applyActionCode,
    signInWithEmailLink,
    isSignInWithEmailLink 
  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAszg47yTdrGvq7Tr5xnuyx0qnj8SmAgL0",
    authDomain: "thegrandchess9-2869e.firebaseapp.com",
    projectId: "thegrandchess9-2869e",
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);

  const UI = {
    authSection: document.getElementById('authSection'),
    unverifiedSection: document.getElementById('unverifiedSection'),
    profileSection: document.getElementById('profileSection'),
    gameMenu: document.getElementById('gameMenu'),
    heroSection: document.getElementById('heroSection'),
    gameContainer: document.getElementById('gameContainer'),
    
    emailInput: document.getElementById('email'),
    passInput: document.getElementById('password'),
    
    loginBtn: document.getElementById('loginBtn'),
    signupBtn: document.getElementById('signupBtn'),
    logoutBtn: document.getElementById('logoutBtn'),
    logoutUnverifiedBtn: document.getElementById('logoutUnverifiedBtn'),
    resendBtn: document.getElementById('resendBtn'),
    
    pendingEmail: document.getElementById('pendingEmailDisplay'),
    userEmail: document.getElementById('userEmailDisplay'),
    
    gameFrame: document.getElementById('gameFrame'),
    gameLoader: document.getElementById('gameLoader'),
    
    toast: document.getElementById('toast'),
    toastIcon: document.getElementById('toast-icon'),
    toastMsg: document.getElementById('toast-msg'),
    status: document.getElementById('connectionStatus')
  };

  function showToast(message, type = 'info') {
    UI.toastMsg.innerText = message;
    UI.toast.className = ''; 
    UI.toast.classList.add(type);
    UI.toast.classList.add('show');
    
    let icon = '‚ÑπÔ∏è';
    if(type === 'success') icon = '‚úÖ';
    if(type === 'error') icon = '‚ùå';
    UI.toastIcon.innerText = icon;

    setTimeout(() => {
      UI.toast.classList.remove('show');
    }, 4000);
  }

  function setBtnLoading(btn, isLoading, defaultText) {
    if (isLoading) {
      btn.disabled = true;
      btn.innerHTML = `<div class="spinner"></div> Processing...`;
    } else {
      btn.disabled = false;
      btn.innerHTML = `<span class="btn-text">${defaultText}</span>`;
    }
  }

  // --- AUTO-LOGIN SYSTEM ---
  async function checkEmailVerification() {
    if (isSignInWithEmailLink(auth, window.location.href)) {
      showToast('Verifying email & logging you in...', 'info');
      UI.status.innerText = '‚óè Verifying...';
      UI.status.style.color = '#eab308';

      let email = window.localStorage.getItem('emailForSignIn');
      if (!email) {
        email = UI.emailInput.value;
      }

      if (!email) {
        showToast('Error: Email missing. Please try again.', 'error');
        window.location.href = window.location.pathname;
        return;
      }

      try {
        const result = await signInWithEmailLink(auth, email, window.location.href);
        window.localStorage.removeItem('emailForSignIn');
        showToast('Email Verified! Logged in successfully.', 'success');
        window.history.replaceState({}, document.title, window.location.pathname);
      } catch (error) {
        console.error(error);
        showToast('Auto-login failed: ' + error.message, 'error');
        window.location.href = window.location.pathname;
      }
    }
  }

  // --- AUTH LOGIC ---

  UI.signupBtn.addEventListener('click', () => {
    const email = UI.emailInput.value.trim();
    const password = UI.passInput.value.trim();

    if (!email || !password) return showToast('Please fill all fields.', 'error');
    if (password.length < 6) return showToast('Password must be 6+ chars.', 'error');

    setBtnLoading(UI.signupBtn, true, 'Create Account');

    createUserWithEmailAndPassword(auth, email, password)
      .then((userCredential) => {
        const user = userCredential.user;
        window.localStorage.setItem('emailForSignIn', email);

        const actionCodeSettings = {
          url: window.location.href,
          handleCodeInApp: true
        };

        sendEmailVerification(user, actionCodeSettings)
          .then(() => {
            showToast('Account created! Check email to verify.', 'success');
            signOut(auth); 
            setBtnLoading(UI.signupBtn, false, 'Create Account');
          })
          .catch((err) => {
            showToast('Error: ' + err.message, 'error');
            setBtnLoading(UI.signupBtn, false, 'Create Account');
          });
      })
      .catch((error) => {
        let msg = error.message;
        if(error.code === 'auth/email-already-in-use') msg = 'Email already in use.';
        showToast(msg, 'error');
        setBtnLoading(UI.signupBtn, false, 'Create Account');
      });
  });

  UI.loginBtn.addEventListener('click', (e) => {
    e.preventDefault();
    const email = UI.emailInput.value.trim();
    const password = UI.passInput.value.trim();

    if (!email || !password) return showToast('Enter email & password.', 'error');
    setBtnLoading(UI.loginBtn, true, 'Login');

    signInWithEmailAndPassword(auth, email, password)
      .then(async (userCredential) => {
        await userCredential.user.reload();
        const user = userCredential.user;
        
        if (user.emailVerified) {
          showToast('Welcome back!', 'success');
        } else {
          showToast('Please verify your email to play.', 'info');
        }
        updateUI(user);
        setBtnLoading(UI.loginBtn, false, 'Login');
      })
      .catch((error) => {
        let msg = error.message;
        if(error.code === 'auth/invalid-credential') msg = 'Invalid email or password.';
        showToast(msg, 'error');
        setBtnLoading(UI.loginBtn, false, 'Login');
      });
  });

  function handleLogout() {
    signOut(auth).then(() => {
      showToast('Logged out.', 'info');
      UI.gameFrame.src = '';
      UI.gameContainer.style.display = 'none';
      UI.heroSection.style.display = 'block';
    });
  }
  UI.logoutBtn.addEventListener('click', handleLogout);
  UI.logoutUnverifiedBtn.addEventListener('click', handleLogout);

  UI.resendBtn.addEventListener('click', () => {
    const user = auth.currentUser;
    if(user){
      window.localStorage.setItem('emailForSignIn', user.email);
      const actionCodeSettings = {
        url: window.location.href,
        handleCodeInApp: true
      };
      sendEmailVerification(user, actionCodeSettings)
        .then(() => showToast('Verification email sent again.', 'success'))
        .catch(err => showToast(err.message, 'error'));
    }
  });

  // --- UI STATE MANAGER ---
  function updateUI(user) {
    UI.authSection.style.display = 'none';
    UI.unverifiedSection.style.display = 'none';
    UI.profileSection.style.display = 'none';
    UI.gameMenu.style.display = 'none';

    if (user) {
      if (user.emailVerified) {
        UI.profileSection.style.display = 'block';
        UI.gameMenu.style.display = 'block';
        UI.userEmail.innerText = user.email;
        UI.status.innerText = '‚óè Online';
        UI.status.style.color = 'var(--primary)';
      } else {
        UI.unverifiedSection.style.display = 'block';
        UI.pendingEmail.innerText = user.email;
        UI.status.innerText = '‚óè Pending Verification';
        UI.status.style.color = '#eab308';
      }
    } else {
      UI.authSection.style.display = 'block';
      UI.heroSection.style.display = 'block';
      UI.gameContainer.style.display = 'none';
      UI.status.innerText = '‚óè System Ready';
      UI.status.style.color = 'var(--text-muted)';
    }
  }

  onAuthStateChanged(auth, (user) => {
    updateUI(user);
  });

  // --- INIT ---
  checkEmailVerification();

  window.loadGame = function(url) {
    const user = auth.currentUser;
    if (!user) return showToast('Please login first.', 'error');
    if (!user.emailVerified) return showToast('Please verify your email.', 'error');

    UI.heroSection.style.display = 'none';
    UI.gameContainer.style.display = 'flex';
    UI.gameLoader.style.display = 'flex';
    UI.gameFrame.src = '';
    
    setTimeout(() => {
      UI.gameFrame.src = url;
      UI.gameFrame.onload = () => { UI.gameLoader.style.display = 'none'; };
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }, 500);
  };

  window.togglePasswordVisibility = function() {
    const type = UI.passInput.getAttribute('type') === 'password' ? 'text' : 'password';
    UI.passInput.setAttribute('type', type);
  };

</script>
</body>
</html>
