<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>TheGrandChess9 ‚Ä¢ Play Online Chess</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

<style>
:root{
  --bg:#0f172a;
  --panel:#1e293b;
  --accent:#22c55e;
  --accent-hover:#16a34a;
  --danger:#e94560;
  --text:#e5e7eb;
  --text-muted:#94a3b8;
  --border:rgba(255,255,255,.08);
  --header-height: 60px;
}

*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}

html { 
  scroll-behavior: smooth; 
  scroll-padding-top: calc(var(--header-height) + 20px);
  -webkit-text-size-adjust: 100%;
}

body{
  font-family:system-ui,-apple-system,Segoe UI,Roboto;
  background:linear-gradient(180deg,#0f172a,#020617);
  color:var(--text);
  min-height:100vh;
  display:flex; flex-direction:column;
  overflow-x: hidden;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

.brand {
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 22px;
  font-weight: 600;
}

.brand-logo {
  width: 48px;
  height: 48px;
  object-fit: contain;
  background: #ffffff;
  padding: 4px;
  border-radius: 10%;
  box-shadow:
    0 0 6px rgba(255,255,255,0.6),
    0 0 12px rgba(34,197,94,0.6);
}

/* Header - Optimized for mobile */
header{ 
  display:flex; justify-content:space-between; align-items:center; padding:0 16px; 
  height: var(--header-height);
  background:rgba(2, 6, 23, 0.95); border-bottom:1px solid var(--border);
  position: sticky; top: 0; z-index: 100;
  /* Removed backdrop-filter for mobile performance */
}

.brand{font-size:18px;font-weight:700; display:flex; align-items:center; gap:8px;}
.brand span{color:var(--accent)}

.nav { display: none; } 

/* Main Layout - Mobile First */
.app{ display:flex; flex-direction: column; min-height:calc(100vh - var(--header-height));}

/* Sidebar - Optimized */
.sidebar{ 
  background:rgba(15, 23, 42, 0.95); 
  padding:16px; 
  border-bottom:1px solid var(--border);
  display:flex; flex-direction:column; gap:16px;
  order: 2;
}

.card{ 
  background:var(--panel); 
  padding:16px; 
  border-radius:12px; 
  border:1px solid var(--border);
  will-change: transform;
}

.card h3{
  margin-bottom:10px;
  font-size:13px; 
  text-transform:uppercase; 
  color:var(--text-muted); 
  letter-spacing:1px;
}

/* Lock & Verification Screens - Simplified */
.locked-msg, .verify-msg {
    text-align: center;
    padding: 15px;
    border: 1px dashed var(--text-muted);
    border-radius: 8px;
    color: var(--text-muted);
    font-size:13px;
}

.verify-msg {
    background: rgba(234, 179, 8, 0.1);
    border-color: #eab308;
    color: #fef08a;
}

/* Inputs & Buttons - Optimized for touch */
input{ 
  width:100%; 
  padding:12px; 
  border-radius:8px; 
  border:1px solid var(--border); 
  background:#020617; 
  color:white; 
  margin-bottom:10px; 
  outline:none;
  font-size:16px; /* Prevents zoom on iOS */
  -webkit-appearance: none;
}

input:focus{border-color:var(--accent)}

button{ 
  width:100%; 
  padding:12px; 
  margin-bottom:8px; 
  border-radius:8px; 
  border:none; 
  background:#334155; 
  color:white; 
  font-weight:600; 
  cursor:pointer;
  font-size:14px; 
  transition: background-color 0.2s ease;
  -webkit-tap-highlight-color: rgba(255,255,255,0.1);
  touch-action: manipulation;
}

button:hover{ background:#475569;}
button:active{ transform: scale(0.98); }
button.primary{ background:var(--accent); color:#052e16;}
button.primary:hover{ background:var(--accent-hover);}
button.outline { background:transparent; border:1px solid var(--text-muted); color:var(--text-muted); }
button.outline:hover { border-color:white; color:white; }

/* Main Content - Optimized */
.main-content{ 
  padding:16px; 
  display:flex; 
  flex-direction:column; 
  gap:16px;
  order: 1;
  flex: 1;
}

/* Game Section - Performance Optimized */
#gameSection { 
  display:none; 
  height: 70vh; /* Reduced for mobile */
  width: 100%; 
  margin-bottom:16px; 
  margin-top: 10px;
  position: relative;
  transform: translateZ(0); /* Hardware acceleration */
  will-change: transform;
}

iframe{ 
  width:100%; 
  height:100%; 
  border:none; 
  border-radius:12px; 
  background:black;
  /* Performance optimizations */
  transform: translateZ(0);
  will-change: contents;
}

/* Game Loading Spinner - Simplified */
.game-loading {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  display: flex;
  justify-content: center;
  align-items: center;
  background: rgba(15, 23, 42, 0.9);
  border-radius: 12px;
  z-index: 10;
}

.spinner {
  width: 40px;
  height: 40px;
  border: 4px solid rgba(255, 255, 255, 0.1);
  border-radius: 50%;
  border-top-color: var(--accent);
  animation: spin 1s linear infinite;
  /* Performance optimization */
  will-change: transform;
  transform: translateZ(0);
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

/* Warning Box - Simplified */
.warning-box { 
  background: rgba(233, 69, 96, 0.1); 
  border: 1px solid var(--danger); 
  padding:12px; 
  border-radius:8px; 
  font-size:12px; 
  color: #fca5a5; 
  margin-top:10px;
}

/* Toast Notification - Optimized */
#toast{
  position: fixed;
  top: calc(var(--header-height) + 10px);
  left: 50%;
  transform: translateX(-50%) translateZ(0);
  background: var(--panel);
  padding: 12px 20px;
  border-radius: 12px;
  border-left: 4px solid var(--accent);
  box-shadow: 0 4px 12px rgba(0,0,0,0.4);
  z-index: 9999;
  width: 90%;
  max-width: 420px;
  text-align: center;
  font-size: 13px;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.2s ease, transform 0.2s ease;
  will-change: opacity, transform;
}

#toast.show{
  opacity: 1;
  transform: translateX(-50%) translateY(0) translateZ(0);
}

/* Desktop Optimizations */
@media (min-width: 769px) {
    .app { 
      display: grid; 
      grid-template-columns: 280px 1fr; 
    }
    .sidebar { 
      order: 1; 
      border-bottom: none;
      border-right: 1px solid var(--border);
    }
    .main-content { 
      order: 2; 
    }
    .nav { display: block; }
    #gameSection { height: 85vh; }
    header {
      backdrop-filter: blur(10px); /* Re-enable for desktop */
    }
}

@media (max-width: 768px) {
    .sidebar { padding: 12px; }
    .main-content { padding: 12px; }
    #gameSection { height: 60vh; }
    .brand { font-size: 16px; }
    .brand-logo { width: 40px; height: 40px; }
}

/* Reduce motion for users who prefer it */
@media (prefers-reduced-motion: reduce) {
    *, *::before, *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
    }
}
</style>
</head>

<body>

<div id="toast">Notification Message</div>

<header>
  <div class="brand">
  <img src="img/Logo.png" alt="TheGrandChess9 Logo" class="brand-logo">
  <span>TheGrandChess9</span>
</div>
</header>

<div class="app">
<!-- Sidebar -->
<aside class="sidebar">
  <div class="card">
    <h3>üîê Account</h3>
    
    <!-- LOGIN FORM -->
    <div id="authForm">
        <input id="email" placeholder="Email Address" type="email" autocomplete="email">
        <input id="password" type="password" placeholder="Password" autocomplete="current-password">
        <button id="loginBtn" class="primary">Login</button>
        <button id="signupBtn">Sign Up</button>
        <button id="forgotBtn" class="outline">Forgot Password?</button>
    </div>

    <!-- PROFILE (Logged In but NOT Verified) -->
    <div id="verifyProfile" style="display:none;">
        <div class="verify-msg" style="margin-bottom:10px;">
            ‚ö†Ô∏è <strong>Email Not Verified</strong><br>
            Please check your inbox/spam.
        </div>
        <div style="font-size:13px; text-align:center; margin-bottom:10px; color:var(--text-muted);" id="pendingEmail"></div>
        <button id="resendBtn" class="primary">üì© Resend Email</button>
        <button id="logoutBtn1" class="outline">Logout</button>
    </div>

    <!-- PROFILE (Logged In & Verified) -->
    <div id="userProfile" style="display:none; text-align:center;">
        <div style="color:var(--accent); font-weight:bold; margin-bottom:10px; word-break:break-all;" id="displayEmail"></div>
        <button id="logoutBtn" style="background:var(--danger)">Logout</button>
    </div>
  </div>

  <!-- LOCKED CONTENT (Not Logged In) -->
  <div id="lockedContent" class="card">
    <div class="locked-msg">
        üîí <strong>Restricted Access</strong><br>
        Login & Verify Email to Play.
    </div>
  </div>

  <!-- LOCKED CONTENT (Logged In but NOT Verified) -->
  <div id="verifyLockedContent" class="card" style="display:none;">
    <div class="verify-msg">
        üö´ <strong>Access Pending</strong><br>
        Verify email to unlock games.
    </div>
  </div>

  <!-- UNLOCKED CONTENT -->
  <div id="unlockedContent" style="display:none">
    <div class="card">
      <h3>üåç Play Online</h3>
      <button onclick="window.openGame('chess8x8.html')">Chess 8√ó8</button>
      <button onclick="window.openGame('chess9x9.html')">Chess 9√ó9</button>
    </div>

    <div class="card">
      <h3>ü§ñ vs Computer</h3>
      <button onclick="window.openGame('SuperChess8x8.html')">SuperChess8x8</button>
      <button onclick="window.openGame('SuperChess9x9.html')">SuperChess9x9</button>
    </div>
  </div>
</aside>

<main class="main-content">
    <div id="heroMsg" style="text-align:center; padding:10px;">
        <h1 style="color:white; font-size:1.5rem; margin-bottom:5px;">TheGrandChess9</h1>
        <p style="color:var(--text-muted); font-size:13px;">Secure verification required to play.</p>
        
        <div class="warning-box">
            <strong>‚ö†Ô∏è Important:</strong><br>
            If verification link doesn't work, ensure this site is hosted online.
        </div>
    </div>

    <div id="gameSection">
        <div class="game-loading" id="gameLoading" style="display:none;">
            <div class="spinner"></div>
        </div>
        <iframe id="gameFrame" loading="lazy"></iframe>
    </div>
</main>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword,
signOut, sendPasswordResetEmail, onAuthStateChanged, sendEmailVerification, applyActionCode } from
"https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

// Check for mobile and reduce operations
const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

if (window.location.protocol === 'file:') {
    console.error("Firebase Auth requires HTTPS or localhost. File protocol is not supported for email verification.");
    alert("‚ö†Ô∏è WARNING: You are opening this file directly from your computer.\n\nEmail Verification Links will NOT work.\n\nPlease host this file on Netlify, Vercel, or GitHub Pages.");
}

const firebaseConfig = {
  apiKey: "AIzaSyAszg47yTdrGvq7Tr5xnuyx0qnj8SmAgL0",
  authDomain: "thegrandchess9-2869e.firebaseapp.com",
  projectId: "thegrandchess9-2869e",
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);

// Cache DOM elements
const elements = {
  email: document.getElementById("email"),
  password: document.getElementById("password"),
  loginBtn: document.getElementById("loginBtn"),
  signupBtn: document.getElementById("signupBtn"),
  logoutBtn: document.getElementById("logoutBtn"),
  logoutBtn1: document.getElementById("logoutBtn1"),
  resendBtn: document.getElementById("resendBtn"),
  forgotBtn: document.getElementById("forgotBtn"),
  authForm: document.getElementById("authForm"),
  verifyProfile: document.getElementById("verifyProfile"),
  userProfile: document.getElementById("userProfile"),
  pendingEmail: document.getElementById("pendingEmail"),
  displayEmail: document.getElementById("displayEmail"),
  lockedContent: document.getElementById("lockedContent"),
  verifyLockedContent: document.getElementById("verifyLockedContent"),
  unlockedContent: document.getElementById("unlockedContent"),
  toast: document.getElementById('toast'),
  heroMsg: document.getElementById('heroMsg'),
  gameSection: document.getElementById('gameSection'),
  gameLoading: document.getElementById('gameLoading'),
  gameFrame: document.getElementById('gameFrame')
};

// Debounce function for performance
function debounce(func, wait) {
  let timeout;
  return function executedFunction(...args) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
}

// Optimized toast notification
const showToast = debounce((msg, type='info') => {
    elements.toast.innerText = msg;
    elements.toast.style.borderLeftColor = type === 'error' ? '#e94560' : '#22c55e';
    elements.toast.classList.add('show');
    setTimeout(() => elements.toast.classList.remove('show'), 3000);
}, 100);

// Check if the URL contains an action code (for email verification)
function handleEmailVerification() {
    const urlParams = new URLSearchParams(window.location.search);
    const mode = urlParams.get('mode');
    const actionCode = urlParams.get('oobCode');
    
    if (mode === 'verifyEmail' && actionCode) {
        applyActionCode(auth, actionCode)
        .then(() => {
            showToast("Email verified! You can now login.", 'success');
            window.history.replaceState({}, document.title, window.location.pathname);
        })
        .catch((error) => {
            showToast("Error: " + error.message, 'error');
            console.error("Error applying action code:", error);
        });
    }
}

// Call this function on page load
handleEmailVerification();

// SIGN UP LOGIC
elements.signupBtn.onclick = () => {
  const email = elements.email.value.trim();
  const pass = elements.password.value.trim();
  if(!email || !pass) return showToast("Please fill all fields", 'error');

  createUserWithEmailAndPassword(auth, email, pass)
  .then(({user}) => {
    const actionCodeSettings = {
      url: window.location.origin + window.location.pathname,
      handleCodeInApp: true 
    };

    sendEmailVerification(user, actionCodeSettings)
    .then(() => {
        showToast("Verification email sent!", 'success');
        if (!isMobile) {
            alert("EMAIL SENT!\n\nPlease check your inbox or Spam folder.");
        }
        signOut(auth); 
    })
    .catch((err) => {
        console.error(err);
        showToast("Error: " + err.message, 'error');
    });
  })
  .catch(err => showToast(err.message, 'error'));
}

// LOGIN LOGIC
elements.loginBtn.onclick = () => {
  if(!elements.email.value || !elements.password.value) return showToast("Enter details", 'error');
  
  signInWithEmailAndPassword(auth, elements.email.value, elements.password.value)
  .then(async ({user}) => {
    await user.reload(); 
    
    if(user.emailVerified){
        updateUI(user);
        showToast("Logged in successfully!", 'success');
    } else {
        showToast("Please verify your email first.", 'error');
        updateUI(user);
    }
  })
  .catch(err => showToast(err.message, 'error'));
}

// LOGOUT
elements.logoutBtn.onclick = () => signOut(auth).then(()=>{ 
    updateUI(null); 
    showToast("Logged out", 'info');
    // Reset game view
    elements.heroMsg.style.display = 'block';
    elements.gameSection.style.display = 'none';
    elements.gameFrame.src = '';
});

elements.logoutBtn1.onclick = () => signOut(auth).then(()=>{ 
    updateUI(null); 
    showToast("Logged out", 'info');
});

// RESEND VERIFICATION
elements.resendBtn.onclick = () => {
    const user = auth.currentUser;
    if(user && !user.emailVerified){
        const actionCodeSettings = {
            url: window.location.origin + window.location.pathname,
            handleCodeInApp: true
        };
        sendEmailVerification(user, actionCodeSettings)
        .then(() => showToast("Verification email resent!", 'success'))
        .catch(err => showToast(err.message, 'error'));
    }
}

// FORGOT PASSWORD
elements.forgotBtn.onclick = () => {
    if(!elements.email.value) return showToast("Enter email first", 'error');
    sendPasswordResetEmail(auth, elements.email.value)
    .then(()=>showToast("Reset email sent!", 'success'))
    .catch(err=>showToast(err.message, 'error'));
}

// UI STATE MANAGER - Optimized
function updateUI(user){
    // Hide all first
    elements.authForm.style.display = 'none';
    elements.userProfile.style.display = 'none';
    elements.verifyProfile.style.display = 'none';
    elements.lockedContent.style.display = 'none';
    elements.verifyLockedContent.style.display = 'none';
    elements.unlockedContent.style.display = 'none';

    if (user) {
        if (user.emailVerified) {
            elements.userProfile.style.display = 'block';
            elements.displayEmail.innerText = user.email;
            elements.unlockedContent.style.display = 'block';
        } else {
            elements.verifyProfile.style.display = 'block';
            elements.pendingEmail.innerText = user.email;
            elements.verifyLockedContent.style.display = 'block';
        }
    } else {
        elements.authForm.style.display = 'block';
        elements.lockedContent.style.display = 'block';
    }
}

// AUTH STATE LISTENER - Optimized
let authStateTimer;
onAuthStateChanged(auth, (user) => {
    // Clear previous timer
    if (authStateTimer) clearTimeout(authStateTimer);
    
    // Debounce auth state changes
    authStateTimer = setTimeout(() => {
        if(user){
            user.reload().then(() => {
                updateUI(user);
            });
        } else { 
            updateUI(null); 
        }
    }, isMobile ? 300 : 100); // Longer delay on mobile
});

// Make the openGame function globally accessible - Optimized
window.openGame = function(url) {
    const user = auth.currentUser;
    
    if (!user) {
        showToast("Please login first", 'error');
        return;
    }
    
    if (!user.emailVerified) {
        showToast("Please verify your email first", 'error');
        return;
    }
    
    // Hide hero, show game section
    elements.heroMsg.style.display = 'none';
    elements.gameSection.style.display = 'block';
    elements.gameLoading.style.display = 'flex';
    
    // Clear previous game
    elements.gameFrame.src = 'about:blank';
    
    // Load new game with delay for better UX
    setTimeout(() => {
        elements.gameFrame.onload = function() {
            elements.gameLoading.style.display = 'none';
        };
        
        elements.gameFrame.onerror = function() {
            elements.gameLoading.style.display = 'none';
            showToast("Failed to load game", 'error');
        };
        
        elements.gameFrame.src = url;
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }, 100);
};

// Clean up on page unload
window.addEventListener('beforeunload', () => {
    if (elements.gameFrame) {
        elements.gameFrame.src = 'about:blank';
    }
});

// Performance monitoring
if (window.performance && window.performance.memory) {
    setInterval(() => {
        if (window.performance.memory.usedJSHeapSize > 50000000) { // 50MB
            console.warn('High memory usage detected');
            // Force garbage collection if available
            if (window.gc) window.gc();
        }
    }, 30000);
}
</script>

</body>
</html>
